name: Load & Chaos Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Which test category to run'
        required: true
        type: choice
        options:
          - all
          - load-tests
          - chaos-tests
          - cluster-tests
        default: 'all'
      timeout_minutes:
        description: 'Timeout in minutes (default: 60)'
        required: false
        type: number
        default: 60

# Cancel in-progress workflows for the same branch
concurrency:
  group: load-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write  # For creating issues on test failures

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  # =========================================
  # Load Tests (T11-T14) - Nightly
  # =========================================
  load-tests:
    name: Load Tests (T11-T14)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'load-tests')
      || (github.event_name == 'schedule' && github.event.schedule == '0 2 * * 1-5')
    timeout-minutes: ${{ github.event.inputs.timeout_minutes || 60 }}
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          prefix-key: "load-tests"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Create data directory
        run: mkdir -p neuroquantum_data/{tables,indexes,logs,quantum}

      # T11: test_read_throughput_scaling
      - name: "T11: Read Throughput Scaling Test"
        id: t11
        run: |
          echo "=== T11: test_read_throughput_scaling ===" 
          cargo test --package neuroquantum-core \
            --test concurrency_load_tests \
            test_read_throughput_scaling \
            --release -- --ignored --nocapture 2>&1 | tee t11_output.log
        continue-on-error: true

      # T12: test_write_throughput_scaling
      - name: "T12: Write Throughput Scaling Test"
        id: t12
        run: |
          echo "=== T12: test_write_throughput_scaling ==="
          cargo test --package neuroquantum-core \
            --test concurrency_load_tests \
            test_write_throughput_scaling \
            --release -- --ignored --nocapture 2>&1 | tee t12_output.log
        continue-on-error: true

      # T13: test_sustained_load_stability
      - name: "T13: Sustained Load Stability Test"
        id: t13
        run: |
          echo "=== T13: test_sustained_load_stability ==="
          cargo test --package neuroquantum-core \
            --test concurrency_load_tests \
            test_sustained_load_stability \
            --release -- --ignored --nocapture 2>&1 | tee t13_output.log
        continue-on-error: true

      # T14: test_load_test_summary
      - name: "T14: Load Test Summary"
        id: t14
        run: |
          echo "=== T14: test_load_test_summary ==="
          cargo test --package neuroquantum-core \
            --test concurrency_load_tests \
            test_load_test_summary \
            --release -- --ignored --nocapture 2>&1 | tee t14_output.log
        continue-on-error: true

      - name: Collect Load Test Results
        run: |
          echo "# Load Test Results" > load-test-results.md
          echo "" >> load-test-results.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> load-test-results.md
          echo "**Commit**: ${{ github.sha }}" >> load-test-results.md
          echo "" >> load-test-results.md
          echo "| Test | Status |" >> load-test-results.md
          echo "|------|--------|" >> load-test-results.md
          echo "| T11: Read Throughput Scaling | ${{ steps.t11.outcome }} |" >> load-test-results.md
          echo "| T12: Write Throughput Scaling | ${{ steps.t12.outcome }} |" >> load-test-results.md
          echo "| T13: Sustained Load Stability | ${{ steps.t13.outcome }} |" >> load-test-results.md
          echo "| T14: Load Test Summary | ${{ steps.t14.outcome }} |" >> load-test-results.md
          echo "" >> load-test-results.md
          echo "## Detailed Output" >> load-test-results.md
          for log in t*.log; do
            if [ -f "$log" ]; then
              echo "" >> load-test-results.md
              echo "### $log" >> load-test-results.md
              echo '```' >> load-test-results.md
              tail -100 "$log" >> load-test-results.md
              echo '```' >> load-test-results.md
            fi
          done

      - name: Upload Load Test Results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results-${{ github.sha }}
          path: |
            load-test-results.md
            t*.log
          retention-days: 30

  # =========================================
  # Chaos Engineering Tests (T15-T17) - Nightly
  # =========================================
  chaos-tests:
    name: Chaos Engineering Tests (T15-T17)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'chaos-tests')
      || (github.event_name == 'schedule' && github.event.schedule == '0 2 * * 1-5')
    timeout-minutes: ${{ github.event.inputs.timeout_minutes || 90 }}
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          prefix-key: "chaos-tests"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Create data directory
        run: mkdir -p neuroquantum_data/{tables,indexes,logs,quantum}

      # T15: test_concurrent_transactions_crash
      - name: "T15: Concurrent Transactions Crash Test"
        id: t15
        run: |
          echo "=== T15: test_concurrent_transactions_crash ==="
          cargo test --package neuroquantum-core \
            --test chaos_engineering_tests \
            test_concurrent_transactions_crash \
            --release -- --ignored --nocapture 2>&1 | tee t15_output.log
        continue-on-error: true

      # T16: test_acid_properties_after_crash
      - name: "T16: ACID Properties After Crash Test"
        id: t16
        run: |
          echo "=== T16: test_acid_properties_after_crash ==="
          cargo test --package neuroquantum-core \
            --test chaos_engineering_tests \
            test_acid_properties_after_crash \
            --release -- --ignored --nocapture 2>&1 | tee t16_output.log
        continue-on-error: true

      # T17: test_repeated_crash_recovery_cycles
      - name: "T17: Repeated Crash Recovery Cycles Test"
        id: t17
        run: |
          echo "=== T17: test_repeated_crash_recovery_cycles ==="
          cargo test --package neuroquantum-core \
            --test chaos_engineering_tests \
            test_repeated_crash_recovery_cycles \
            --release -- --ignored --nocapture 2>&1 | tee t17_output.log
        continue-on-error: true

      - name: Collect Chaos Test Results
        run: |
          echo "# Chaos Engineering Test Results" > chaos-test-results.md
          echo "" >> chaos-test-results.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> chaos-test-results.md
          echo "**Commit**: ${{ github.sha }}" >> chaos-test-results.md
          echo "" >> chaos-test-results.md
          echo "| Test | Status |" >> chaos-test-results.md
          echo "|------|--------|" >> chaos-test-results.md
          echo "| T15: Concurrent Transactions Crash | ${{ steps.t15.outcome }} |" >> chaos-test-results.md
          echo "| T16: ACID Properties After Crash | ${{ steps.t16.outcome }} |" >> chaos-test-results.md
          echo "| T17: Repeated Crash Recovery Cycles | ${{ steps.t17.outcome }} |" >> chaos-test-results.md
          echo "" >> chaos-test-results.md
          echo "## Detailed Output" >> chaos-test-results.md
          for log in t*.log; do
            if [ -f "$log" ]; then
              echo "" >> chaos-test-results.md
              echo "### $log" >> chaos-test-results.md
              echo '```' >> chaos-test-results.md
              tail -100 "$log" >> chaos-test-results.md
              echo '```' >> chaos-test-results.md
            fi
          done

      - name: Upload Chaos Test Results
        uses: actions/upload-artifact@v4
        with:
          name: chaos-test-results-${{ github.sha }}
          path: |
            chaos-test-results.md
            t*.log
          retention-days: 30

  # =========================================
  # Cluster E2E Tests (T18-T19) - Weekly
  # =========================================
  cluster-tests:
    name: Cluster E2E Tests (T18-T19)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'cluster-tests')
      || (github.event_name == 'schedule' && github.event.schedule == '0 3 * * 0')
    timeout-minutes: ${{ github.event.inputs.timeout_minutes || 120 }}
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          prefix-key: "cluster-tests"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Create data directory
        run: mkdir -p neuroquantum_data/{tables,indexes,logs,quantum}

      # T18: test_chaos_random_node_kills
      - name: "T18: Chaos Random Node Kills Test"
        id: t18
        run: |
          echo "=== T18: test_chaos_random_node_kills ==="
          cargo test --package neuroquantum-core \
            --test cluster_e2e_tests \
            test_chaos_random_node_kills \
            --release -- --ignored --nocapture 2>&1 | tee t18_output.log
        continue-on-error: true

      # T19: test_chaos_concurrent_load_with_failures
      - name: "T19: Chaos Concurrent Load With Failures Test"
        id: t19
        run: |
          echo "=== T19: test_chaos_concurrent_load_with_failures ==="
          cargo test --package neuroquantum-core \
            --test cluster_e2e_tests \
            test_chaos_concurrent_load_with_failures \
            --release -- --ignored --nocapture 2>&1 | tee t19_output.log
        continue-on-error: true

      - name: Collect Cluster Test Results
        run: |
          echo "# Cluster E2E Test Results" > cluster-test-results.md
          echo "" >> cluster-test-results.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> cluster-test-results.md
          echo "**Commit**: ${{ github.sha }}" >> cluster-test-results.md
          echo "" >> cluster-test-results.md
          echo "| Test | Status |" >> cluster-test-results.md
          echo "|------|--------|" >> cluster-test-results.md
          echo "| T18: Chaos Random Node Kills | ${{ steps.t18.outcome }} |" >> cluster-test-results.md
          echo "| T19: Chaos Concurrent Load With Failures | ${{ steps.t19.outcome }} |" >> cluster-test-results.md
          echo "" >> cluster-test-results.md
          echo "## Detailed Output" >> cluster-test-results.md
          for log in t*.log; do
            if [ -f "$log" ]; then
              echo "" >> cluster-test-results.md
              echo "### $log" >> cluster-test-results.md
              echo '```' >> cluster-test-results.md
              tail -100 "$log" >> cluster-test-results.md
              echo '```' >> cluster-test-results.md
            fi
          done

      - name: Upload Cluster Test Results
        uses: actions/upload-artifact@v4
        with:
          name: cluster-test-results-${{ github.sha }}
          path: |
            cluster-test-results.md
            t*.log
          retention-days: 30

  # =========================================
  # Summary & Notification
  # =========================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [load-tests, chaos-tests, cluster-tests]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: all-results
        continue-on-error: true

      - name: Generate Summary Report
        run: |
          echo "# NeuroQuantumDB Load & Chaos Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Load Tests (T11-T14) | ${{ needs.load-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chaos Tests (T15-T17) | ${{ needs.chaos-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster Tests (T18-T19) | ${{ needs.cluster-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Load Tests (Nightly)" >> $GITHUB_STEP_SUMMARY
          echo "- T11: test_read_throughput_scaling - Read-Durchsatz-Skalierung" >> $GITHUB_STEP_SUMMARY
          echo "- T12: test_write_throughput_scaling - Write-Durchsatz-Skalierung" >> $GITHUB_STEP_SUMMARY
          echo "- T13: test_sustained_load_stability - Langzeit-Stabilit채t unter Last" >> $GITHUB_STEP_SUMMARY
          echo "- T14: test_load_test_summary - Zusammenfassungsbericht" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Chaos Engineering Tests (Nightly)" >> $GITHUB_STEP_SUMMARY
          echo "- T15: test_concurrent_transactions_crash - Crash w채hrend Transaktionen" >> $GITHUB_STEP_SUMMARY
          echo "- T16: test_acid_properties_after_crash - ACID-Verifizierung nach Crash" >> $GITHUB_STEP_SUMMARY
          echo "- T17: test_repeated_crash_recovery_cycles - Wiederholte Crash-Recovery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cluster E2E Tests (Weekly)" >> $GITHUB_STEP_SUMMARY
          echo "- T18: test_chaos_random_node_kills - Zuf채lliges Node-Beenden" >> $GITHUB_STEP_SUMMARY
          echo "- T19: test_chaos_concurrent_load_with_failures - Last mit Ausf채llen" >> $GITHUB_STEP_SUMMARY

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Load Tests] Test Failures - ${date}`,
              body: `## Load & Chaos Test Failures
              
              **Workflow Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Commit**: ${context.sha}
              **Date**: ${date}
              
              One or more load/chaos tests failed. Please review the workflow run for details.
              
              ### Failed Jobs
              - Load Tests: ${{ needs.load-tests.result || 'skipped' }}
              - Chaos Tests: ${{ needs.chaos-tests.result || 'skipped' }}
              - Cluster Tests: ${{ needs.cluster-tests.result || 'skipped' }}
              `,
              labels: ['bug', 'automated', 'load-tests']
            });
            console.log(`Created issue #${issue.data.number}`);
        continue-on-error: true
