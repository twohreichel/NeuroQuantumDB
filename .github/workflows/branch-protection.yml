name: Branch Protection

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  # This job ensures all PR checks must pass before merge
  pr-gate:
    name: PR Gate Check
    runs-on: ubuntu-latest
    needs: []  # This will be updated by the main CI to require pr-checks

    steps:
    - name: PR Gate
      run: |
        echo "All PR checks must pass before merge is allowed"
        echo "Required checks: formatting, clippy, security-audit, dependency-check, unused-deps, comprehensive-lint"

  # Status check job that other workflows can depend on
  all-pr-checks-passed:
    name: All PR Checks Passed
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Wait for PR checks
      uses: fountainhead/action-wait-for-check@v1.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        checkName: "Pull Request Checks"
        ref: ${{ github.event.pull_request.head.sha }}
        timeoutSeconds: 1800  # 30 minutes timeout
        intervalSeconds: 30

    - name: Verify all checks passed
      run: echo "All required PR checks have passed successfully"
