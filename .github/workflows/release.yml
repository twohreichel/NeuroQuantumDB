name: Release Please

on:
  push:
    branches: [main]
  workflow_dispatch:

# Only allow one release workflow at a time
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      paths_released: ${{ steps.release.outputs.paths_released }}
      # PHP driver
      php_release_created: ${{ steps.release.outputs['connecting-libraries/php--release_created'] }}
      php_tag_name: ${{ steps.release.outputs['connecting-libraries/php--tag_name'] }}
      php_version: ${{ steps.release.outputs['connecting-libraries/php--version'] }}
      # neuroquantum-core
      core_release_created: ${{ steps.release.outputs['crates/neuroquantum-core--release_created'] }}
      core_tag_name: ${{ steps.release.outputs['crates/neuroquantum-core--tag_name'] }}
      core_version: ${{ steps.release.outputs['crates/neuroquantum-core--version'] }}
      # neuroquantum-qsql
      qsql_release_created: ${{ steps.release.outputs['crates/neuroquantum-qsql--release_created'] }}
      qsql_tag_name: ${{ steps.release.outputs['crates/neuroquantum-qsql--tag_name'] }}
      qsql_version: ${{ steps.release.outputs['crates/neuroquantum-qsql--version'] }}
      # neuroquantum-cluster
      cluster_release_created: ${{ steps.release.outputs['crates/neuroquantum-cluster--release_created'] }}
      cluster_tag_name: ${{ steps.release.outputs['crates/neuroquantum-cluster--tag_name'] }}
      cluster_version: ${{ steps.release.outputs['crates/neuroquantum-cluster--version'] }}
      # neuroquantum-api
      api_release_created: ${{ steps.release.outputs['crates/neuroquantum-api--release_created'] }}
      api_tag_name: ${{ steps.release.outputs['crates/neuroquantum-api--tag_name'] }}
      api_version: ${{ steps.release.outputs['crates/neuroquantum-api--version'] }}
      # neuroquantum-wasm
      wasm_release_created: ${{ steps.release.outputs['crates/neuroquantum-wasm--release_created'] }}
      wasm_tag_name: ${{ steps.release.outputs['crates/neuroquantum-wasm--tag_name'] }}
      wasm_version: ${{ steps.release.outputs['crates/neuroquantum-wasm--version'] }}
    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Summary of releases
        run: |
          echo "### Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Released | Version | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| neuroquantum-core | ${{ steps.release.outputs['crates/neuroquantum-core--release_created'] || 'false' }} | ${{ steps.release.outputs['crates/neuroquantum-core--version'] || '-' }} | ${{ steps.release.outputs['crates/neuroquantum-core--tag_name'] || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| neuroquantum-qsql | ${{ steps.release.outputs['crates/neuroquantum-qsql--release_created'] || 'false' }} | ${{ steps.release.outputs['crates/neuroquantum-qsql--version'] || '-' }} | ${{ steps.release.outputs['crates/neuroquantum-qsql--tag_name'] || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| neuroquantum-cluster | ${{ steps.release.outputs['crates/neuroquantum-cluster--release_created'] || 'false' }} | ${{ steps.release.outputs['crates/neuroquantum-cluster--version'] || '-' }} | ${{ steps.release.outputs['crates/neuroquantum-cluster--tag_name'] || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| neuroquantum-api | ${{ steps.release.outputs['crates/neuroquantum-api--release_created'] || 'false' }} | ${{ steps.release.outputs['crates/neuroquantum-api--version'] || '-' }} | ${{ steps.release.outputs['crates/neuroquantum-api--tag_name'] || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| neuroquantum-wasm | ${{ steps.release.outputs['crates/neuroquantum-wasm--release_created'] || 'false' }} | ${{ steps.release.outputs['crates/neuroquantum-wasm--version'] || '-' }} | ${{ steps.release.outputs['crates/neuroquantum-wasm--tag_name'] || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| php-driver | ${{ steps.release.outputs['connecting-libraries/php--release_created'] || 'false' }} | ${{ steps.release.outputs['connecting-libraries/php--version'] || '-' }} | ${{ steps.release.outputs['connecting-libraries/php--tag_name'] || '-' }} |" >> $GITHUB_STEP_SUMMARY

  # Build API binary when neuroquantum-api is released
  build-api-binaries:
    name: Build neuroquantum-api (${{ matrix.target }})
    needs: release-please
    if: needs.release-please.outputs.api_release_created == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: neuroquantum-api-linux-x86_64
            cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            name: neuroquantum-api-darwin-arm64
            cross: false
          - target: x86_64-apple-darwin
            os: macos-latest
            name: neuroquantum-api-darwin-x86_64
            cross: false
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: neuroquantum-api-windows-x86_64.exe
            cross: false
    runs-on: ${{ matrix.os }}
    steps:
      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          key: ${{ matrix.target }}
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build release binary
        run: cargo build --release -p neuroquantum-api --target ${{ matrix.target }}

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          if [ "${{ matrix.target }}" = "x86_64-unknown-linux-gnu" ]; then
            strip target/${{ matrix.target }}/release/neuroquantum-api
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            strip target/${{ matrix.target }}/release/neuroquantum-api
          fi

      - name: Prepare artifact (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p release-artifacts
          cp target/${{ matrix.target }}/release/neuroquantum-api release-artifacts/${{ matrix.name }}

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir release-artifacts
          copy target\${{ matrix.target }}\release\neuroquantum-api.exe release-artifacts\${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.name }}
          path: release-artifacts/${{ matrix.name }}
          retention-days: 1

  # Upload API release assets
  upload-api-release-assets:
    name: Upload API Release Assets
    needs: [release-please, build-api-binaries]
    if: needs.release-please.outputs.api_release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: release-artifacts

      - name: Prepare release files
        run: |
          mkdir -p final-release
          for dir in release-artifacts/neuroquantum-api-*; do
            if [ -d "$dir" ]; then
              cp "$dir"/* final-release/ || true
            fi
          done
          ls -la final-release/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.api_tag_name }}
          files: final-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build WASM when neuroquantum-wasm is released
  build-wasm:
    name: Build WASM Package
    needs: release-please
    if: needs.release-please.outputs.wasm_release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build WASM package
        working-directory: crates/neuroquantum-wasm
        run: wasm-pack build --target web --release

      - name: Create npm tarball
        working-directory: crates/neuroquantum-wasm/pkg
        run: npm pack

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v6
        with:
          name: neuroquantum-wasm-pkg
          path: crates/neuroquantum-wasm/pkg/*.tgz
          retention-days: 1

  # Upload WASM release assets
  upload-wasm-release-assets:
    name: Upload WASM Release Assets
    needs: [release-please, build-wasm]
    if: needs.release-please.outputs.wasm_release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download WASM artifact
        uses: actions/download-artifact@v7
        with:
          name: neuroquantum-wasm-pkg
          path: release-artifacts

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.wasm_tag_name }}
          files: release-artifacts/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish individual crates to crates.io when released
  publish-core:
    name: Publish neuroquantum-core to crates.io
    needs: release-please
    if: needs.release-please.outputs.core_release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Publish neuroquantum-core
        run: cargo publish -p neuroquantum-core --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-qsql:
    name: Publish neuroquantum-qsql to crates.io
    needs: [release-please, publish-core]
    if: |
      always() &&
      needs.release-please.outputs.qsql_release_created == 'true' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Wait for crates.io index update
        if: needs.publish-core.result == 'success'
        run: sleep 30

      - name: Publish neuroquantum-qsql
        run: cargo publish -p neuroquantum-qsql --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-cluster:
    name: Publish neuroquantum-cluster to crates.io
    needs: [release-please, publish-qsql]
    if: |
      always() &&
      needs.release-please.outputs.cluster_release_created == 'true' &&
      (needs.publish-qsql.result == 'success' || needs.publish-qsql.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Wait for crates.io index update
        if: needs.publish-qsql.result == 'success'
        run: sleep 30

      - name: Publish neuroquantum-cluster
        run: cargo publish -p neuroquantum-cluster --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-api:
    name: Publish neuroquantum-api to crates.io
    needs: [release-please, publish-cluster]
    if: |
      always() &&
      needs.release-please.outputs.api_release_created == 'true' &&
      (needs.publish-cluster.result == 'success' || needs.publish-cluster.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Wait for crates.io index update
        if: needs.publish-cluster.result == 'success'
        run: sleep 30

      - name: Publish neuroquantum-api
        run: cargo publish -p neuroquantum-api --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-wasm:
    name: Publish neuroquantum-wasm to crates.io
    needs: [release-please, publish-api]
    if: |
      always() &&
      needs.release-please.outputs.wasm_release_created == 'true' &&
      (needs.publish-api.result == 'success' || needs.publish-api.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Wait for crates.io index update
        if: needs.publish-api.result == 'success'
        run: sleep 30

      - name: Publish neuroquantum-wasm
        run: cargo publish -p neuroquantum-wasm --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Publish PHP Driver when released
  publish-php-driver:
    name: Publish PHP Driver
    needs: release-please
    if: needs.release-please.outputs.php_release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Create PHP Driver release archive
        run: |
          cd connecting-libraries/php
          zip -r ../../php-driver-${{ needs.release-please.outputs.php_version }}.zip . \
            -x "vendor/*" \
            -x ".git/*" \
            -x ".gitignore" \
            -x "composer.lock"
          tar -czvf ../../php-driver-${{ needs.release-please.outputs.php_version }}.tar.gz \
            --exclude="vendor" \
            --exclude=".git" \
            --exclude=".gitignore" \
            --exclude="composer.lock" \
            .

      - name: Upload PHP Driver release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.php_tag_name }}
          name: "PHP Driver v${{ needs.release-please.outputs.php_version }}"
          files: |
            php-driver-${{ needs.release-please.outputs.php_version }}.zip
            php-driver-${{ needs.release-please.outputs.php_version }}.tar.gz
          body: |
            ## PHP Driver for NeuroQuantumDB v${{ needs.release-please.outputs.php_version }}
            
            > **Note:** The automatically generated "Source code" archives below contain the entire NeuroQuantumDB repository. 
            > Please use the `php-driver-*.zip` or `php-driver-*.tar.gz` files above for the PHP driver only.
            
            ### Installation
            ```bash
            composer require neuroquantum/php-driver:^${{ needs.release-please.outputs.php_version }}
            ```
            
            ### Downloads
            - `php-driver-${{ needs.release-please.outputs.php_version }}.zip` - PHP Driver ZIP archive
            - `php-driver-${{ needs.release-please.outputs.php_version }}.tar.gz` - PHP Driver Tarball
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ needs.release-please.outputs.php_tag_name }}/connecting-libraries/php/CHANGELOG.md) for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: PHP Driver Release Info
        run: |
          echo "ðŸŽ‰ PHP Driver ${{ needs.release-please.outputs.php_version }} released!"
          echo "Tag: ${{ needs.release-please.outputs.php_tag_name }}"
          echo ""
          echo "Packagist will automatically sync the new version via GitHub webhook."
          echo "Install with: composer require neuroquantum/php-driver:^${{ needs.release-please.outputs.php_version }}"
