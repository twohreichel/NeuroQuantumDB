name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  push:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # PR validation jobs - run on pull requests
  pr-checks:
    if: github.event_name == 'pull_request'
    name: Pull Request Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust-version: [stable, beta]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust-version }}
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ matrix.rust-version }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.rust-version }}-
          ${{ runner.os }}-cargo-

    - name: Install cargo tools
      run: |
        cargo install --locked cargo-audit cargo-machete cargo-unused-features
        rustup component add rustfmt clippy

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run Clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Security audit
      run: cargo audit

    - name: Dependency check
      run: cargo tree --duplicates

    - name: Check unused dependencies
      run: cargo machete

    - name: Comprehensive lint
      run: |
        # Additional comprehensive linting
        cargo clippy --all-targets --all-features -- -D clippy::all -D clippy::pedantic -D clippy::cargo
        
        # Check for unused features
        cargo unused-features analyze
        
        # Check documentation
        cargo doc --no-deps --document-private-items

  # Full pipeline jobs - run only on main branch
  build-and-test:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust-version: [stable, beta, nightly]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust-version }}
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ matrix.rust-version }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Build all crates
      run: cargo build --verbose --all-features

    - name: Run tests
      run: cargo test --verbose --all-features

    - name: Run integration tests
      run: cargo test --test integration_tests

    - name: Run benchmarks
      run: cargo bench --no-run

  security-scan:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install security tools
      run: |
        cargo install --locked cargo-audit cargo-deny

    - name: Run cargo audit
      run: cargo audit

    - name: Run cargo deny
      run: cargo deny check

  performance-tests:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-performance-${{ hashFiles('**/Cargo.lock') }}

    - name: Run performance benchmarks
      run: cargo bench

  docker-build:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t neuroquantumdb:latest .
        docker images

    - name: Test Docker image
      run: |
        docker run --rm neuroquantumdb:latest --version

  documentation:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Generate Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install mdbook
      run: |
        curl -L https://github.com/rust-lang/mdBook/releases/download/v0.4.36/mdbook-v0.4.36-x86_64-unknown-linux-gnu.tar.gz | tar xz
        chmod +x mdbook

    - name: Generate API documentation
      run: cargo doc --no-deps --all-features

    - name: Build book documentation
      run: ./mdbook build

    - name: Deploy documentation
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./target/book
