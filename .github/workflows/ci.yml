name: NeuroQuantumDB CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write
  packages: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  formatting:
    name: Code Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cache Rust toolchain
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "formatting"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Check code formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust dependencies and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "clippy"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "security"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Cache security tools
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: security-tools-${{ runner.os }}-v2

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit --locked
          else
            echo "cargo-audit already installed, using cached version"
          fi

      - name: Run security audit
        run: cargo audit

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "dependency-check"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Cache cargo-deny
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-deny
          key: cargo-deny-${{ runner.os }}-v2

      - name: Install cargo-deny
        run: |
          if ! command -v cargo-deny &> /dev/null; then
            cargo install cargo-deny --locked
          else
            echo "cargo-deny already installed, using cached version"
          fi

      - name: Check licenses
        run: cargo deny check licenses

      - name: Check advisories
        run: cargo deny check advisories

      - name: Check bans
        run: cargo deny check bans

      - name: Check sources
        run: cargo deny check sources

  unused-deps:
    name: Unused Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "unused-deps"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Cache cargo-machete
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-machete
          key: cargo-machete-${{ runner.os }}-v2

      - name: Install cargo-machete
        run: |
          if ! command -v cargo-machete &> /dev/null; then
            cargo install cargo-machete --locked
          else
            echo "cargo-machete already installed, using cached version"
          fi

      - name: Check unused dependencies
        run: cargo machete

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: [formatting, clippy, security-audit, dependency-check, unused-deps]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for TODO/FIXME comments
        run: |
          echo "ðŸ” Checking for TODO/FIXME comments in production code..."
          if grep -r "TODO\\|FIXME" crates/ --include="*.rs" | grep -v "test" | head -10; then
            echo "âš ï¸  Found TODO/FIXME comments in production code"
          fi

      - name: Check for unsafe code
        run: |
          # Check for actual unsafe blocks/functions in Rust code (not in comments)
          # Exclude SIMD modules where unsafe is allowed and necessary for performance
          echo "ðŸ” Checking for unsafe code blocks outside SIMD modules..."
          if grep -r "unsafe fn\|unsafe impl\|unsafe trait\|unsafe {" crates/ --include="*.rs" | \
             grep -v "crates/neuroquantum-core/src/dna/simd/" | \
             grep -v "crates/neuroquantum-core/src/simd/" | \
             grep -v "// " | \
             grep -v "/// "; then
            echo "âŒ Unsafe code detected outside of SIMD modules! Remove all unsafe blocks."
            exit 1
          else
            echo "âœ… No unsafe code found outside SIMD optimizations."
          fi

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies from previous jobs
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "clippy"
          save-if: false

      - name: Cache Rust dependencies and test artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "tests"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run tests
        run: cargo test --all-features --verbose

  build-documentation:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies for docs
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "docs"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Cache mdBook and plugins
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/mdbook
            ~/.cargo/bin/mdbook-linkcheck
            ~/.cargo/bin/mdbook-mermaid
            ~/.cargo/bin/tokei
          key: doc-tools-${{ runner.os }}-v2

      - name: Install mdBook
        run: |
          if ! command -v mdbook &> /dev/null; then
            mkdir mdbook
            curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.36/mdbook-v0.4.36-x86_64-unknown-linux-gnu.tar.gz | tar -xz --directory=./mdbook
            echo `pwd`/mdbook >> $GITHUB_PATH
          else
            echo "mdBook already installed, using cached version"
          fi

      - name: Install mdBook plugins
        run: |
          if ! command -v mdbook-linkcheck &> /dev/null; then
            cargo install mdbook-linkcheck --locked
          else
            echo "mdbook-linkcheck already installed, using cached version"
          fi
          if ! command -v mdbook-mermaid &> /dev/null; then
            cargo install mdbook-mermaid --locked
          else
            echo "mdbook-mermaid already installed, using cached version"
          fi

      - name: Generate API documentation
        run: |
          cargo doc --workspace --all-features --no-deps --document-private-items
          echo '<meta http-equiv="refresh" content="0; url=neuroquantum_api">' > target/doc/index.html

      - name: Generate user documentation
        run: mdbook build

      - name: Generate code metrics
        run: |
          if ! command -v tokei &> /dev/null; then
            cargo install tokei --locked
          else
            echo "tokei already installed, using cached version"
          fi
          mkdir -p target/metrics
          tokei --output json > target/metrics/code-stats.json
          cargo tree --format "{p} {l}" > target/metrics/dependencies.txt

      - name: Create documentation site structure
        run: |
          mkdir -p docs-site
          cp -r target/book/* docs-site/
          cp -r target/doc docs-site/api/
          cp -r target/metrics docs-site/metrics/

      - name: Create main documentation index
        run: |
          cat > docs-site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="de">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>NeuroQuantumDB Documentation</title>
              <style>
                  body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; }
                  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
                  .header { text-align: center; color: white; margin-bottom: 50px; }
                  .header h1 { font-size: 3.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
                  .docs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 50px; }
                  .doc-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease; text-decoration: none; color: inherit; }
                  .doc-card:hover { transform: translateY(-5px); }
                  .doc-card h2 { color: #667eea; margin-bottom: 15px; }
                  .version-info { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; margin-top: 30px; color: white; text-align: center; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ðŸ§  NeuroQuantumDB</h1>
                      <p>Ultra-effiziente neuromorphe Datenbank fÃ¼r Edge Computing</p>
                  </div>
                  <div class="docs-grid">
                      <a href="./introduction.html" class="doc-card">
                          <h2>ðŸ“š Benutzer-Dokumentation</h2>
                          <p>VollstÃ¤ndige Anleitung zur Verwendung von NeuroQuantumDB</p>
                      </a>
                      <a href="./api/" class="doc-card">
                          <h2>ðŸ”§ API Dokumentation</h2>
                          <p>Technische Referenz fÃ¼r Entwickler</p>
                      </a>
                      <a href="./metrics/" class="doc-card">
                          <h2>ðŸ“Š Code Metrics</h2>
                          <p>Projektstatistiken und QualitÃ¤tsmetriken</p>
                      </a>
                  </div>
                  <div class="version-info">
                      <p><strong>Build:</strong> ${{ github.sha }}</p>
                      <p><strong>Date:</strong> $(date)</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs-site/

      - name: Setup GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs-site/

  deploy-docs:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-documentation]
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore Rust cache from test job
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "tests"
          save-if: false

      - name: Install Rust toolchain for Docker context
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install cross-compilation toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libc6-dev-arm64-cross

      - name: Pre-build Rust artifacts for Docker
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++
          AR_aarch64_unknown_linux_gnu: aarch64-linux-gnu-ar
          STRIP_aarch64_unknown_linux_gnu: aarch64-linux-gnu-strip
          PKG_CONFIG_ALLOW_CROSS: 1
          RUSTFLAGS: "-C target-feature=+neon"
          CC: aarch64-linux-gnu-gcc
          CXX: aarch64-linux-gnu-g++
          AR: aarch64-linux-gnu-ar
          STRIP: aarch64-linux-gnu-strip
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu --features neon-optimizations,neuromorphic,quantum,natural-language --bin neuroquantum-api
          mkdir -p docker-context/target/aarch64-unknown-linux-gnu/release/
          cp target/aarch64-unknown-linux-gnu/release/neuroquantum-api docker-context/target/aarch64-unknown-linux-gnu/release/

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=main-
            type=raw,value=latest

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.0
            network=host

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=docker-build
          cache-to: type=gha,mode=max,scope=docker-build
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            CARGO_INCREMENTAL=0
            CARGO_NET_RETRY=10
            RUST_BACKTRACE=1

  deploy-documentation:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-documentation]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download documentation
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: ./docs-site

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs-site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  lint-results:
    name: Pipeline Results Summary
    runs-on: ubuntu-latest
    needs:
      - formatting
      - clippy
      - security-audit
      - dependency-check
      - unused-deps
      - code-quality
      - test
      - build-documentation
      - build-and-push
      - deploy-documentation
    if: always()
    steps:
      - name: Generate results summary
        run: |
          echo "## ðŸš€ NeuroQuantumDB CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Formatting | ${{ needs.formatting.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy Analysis | ${{ needs.clippy.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unused Dependencies | ${{ needs.unused-deps.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ“š Documentation** | ${{ needs.build-documentation.result == 'success' && 'âœ… Generated' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build-and-push.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸŒ Documentation Deploy** | ${{ needs.deploy-documentation.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“– Documentation Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“š User Documentation](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ”§ API Reference](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api/)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š Code Metrics](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/metrics/)" >> $GITHUB_STEP_SUMMARY
