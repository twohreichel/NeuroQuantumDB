name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Daily security audit at 00:00 UTC
    - cron: '0 0 * * *'

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
          cache-on-failure: true
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings
      - name: Run Clippy (pedantic)
        run: cargo clippy --workspace --all-targets --all-features -- -W clippy::pedantic
        continue-on-error: true  # Advisory f√ºr jetzt
      - name: Post Clippy suggestions
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Clippy found issues. Run `make lint-fix` locally to auto-fix.'
            })

  clippy-versions:
    name: Clippy (Rust ${{ matrix.rust }})
    strategy:
      matrix:
        rust: [stable, beta]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint-${{ matrix.rust }}"
          cache-targets: false
          cache-on-failure: true
      - name: Run Clippy
        run: cargo clippy --workspace --all-features
        continue-on-error: ${{ matrix.rust == 'beta' }}

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run cargo-deny
        run: cargo deny check
      - name: Run cargo-audit
        run: cargo audit
      - name: Post security issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üîí Security audit found issues. Please review the logs and update dependencies.'
            })

  deps:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
      - name: Install cargo-machete
        run: cargo install cargo-machete --locked
      - name: Check unused dependencies
        run: cargo machete
      - name: Post dependency issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üì¶ Found unused dependencies. Run `cargo machete` locally to identify them.'
            })

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
      - name: Check documentation
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps --all-features --workspace
      - name: Post documentation issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üìö Documentation build failed. Please fix doc comments and warnings.'
            })

  lint-complete:
    name: All Lints Passed
    needs: [fmt, clippy, clippy-versions, security, deps, docs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.clippy-versions.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.deps.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "‚ùå Some lint checks failed!"
            exit 1
          fi
          echo "‚úÖ All lint checks passed!"
