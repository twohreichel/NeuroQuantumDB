name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - uses: actions/checkout@v6
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
          cache-on-failure: true
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings
      - name: Post Clippy suggestions
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Clippy found issues. Run `make lint-fix` locally to auto-fix.'
            })

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - uses: actions/checkout@v6
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Install security tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny,cargo-audit
      - name: Run cargo-deny
        run: cargo deny check
      - name: Run cargo-audit
        # Clear stale advisory-db to avoid git clone errors, then run with Makefile ignores
        run: |
          rm -rf ~/.cargo/advisory-db
          cargo audit --ignore RUSTSEC-2020-0168 --ignore RUSTSEC-2024-0384 --ignore RUSTSEC-2024-0436 --ignore RUSTSEC-2021-0141 --ignore RUSTSEC-2025-0010 --ignore RUSTSEC-2023-0071 --ignore RUSTSEC-2026-0001
      - name: Post security issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üîí Security audit found issues. Please review the logs and update dependencies.'
            })

  deps:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - uses: actions/checkout@v6
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Install cargo-machete
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-machete
      - name: Check unused dependencies
        run: cargo machete
      - name: Post dependency issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üì¶ Found unused dependencies. Run `cargo machete` locally to identify them.'
            })

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - uses: actions/checkout@v6
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-targets: false
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Check documentation
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps --all-features --workspace

  lint-complete:
    name: All Lints Passed
    needs: [fmt, clippy, security, deps, docs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.deps.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "‚ùå Some lint checks failed!"
            exit 1
          fi
          echo "‚úÖ All lint checks passed!"
