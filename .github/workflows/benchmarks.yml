name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      force_comparison:
        description: 'Force benchmark comparison even on non-PR events'
        required: false
        type: boolean
        default: false

# Cancel in-progress workflows for the same branch
concurrency:
  group: benchmarks-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for baseline comparison

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          prefix-key: "benchmarks"

      - name: Install cargo-criterion
        run: |
          cargo install cargo-criterion --locked || true

      - name: Create data directory
        run: mkdir -p neuroquantum_data/{tables,indexes,logs,quantum}

      # =========================================
      # Run DNA Compression Benchmarks
      # =========================================
      - name: Run DNA Compression Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench dna_compression \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Neuromorphic Index Benchmarks
      # =========================================
      - name: Run Neuromorphic Index Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench neuromorphic_index \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Transaction Benchmarks
      # =========================================
      - name: Run Transaction Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench transactions \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Quantum Algorithm Benchmarks
      # =========================================
      - name: Run Grover Search Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench grover_search \
            --features benchmarks \
            -- --noplot

      - name: Run Quantum Annealing Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench quantum_annealing \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Storage Benchmarks
      # =========================================
      - name: Run B+ Tree Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench btree_benchmark \
            --features benchmarks \
            -- --noplot

      - name: Run Page Storage Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench page_storage_benchmark \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run SIMD Optimization Benchmarks
      # =========================================
      - name: Run NEON/SIMD Optimization Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench neon_optimization \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run QSQL Function Benchmarks
      # =========================================
      - name: Run QSQL Function Benchmarks
        run: |
          cargo bench --package neuroquantum-qsql \
            --bench qsql_functions \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Collect and Process Results
      # =========================================
      - name: Collect benchmark results
        id: collect-results
        run: |
          # Create summary directory
          mkdir -p benchmark-results

          # Generate benchmark summary
          cat << 'EOF' > benchmark-results/summary.md
          # NeuroQuantumDB Benchmark Results

          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Benchmark Categories

          ### ðŸ§¬ DNA Compression
          Performance of DNA-based compression with quaternary encoding and Reed-Solomon error correction.
          Includes comparison with gzip, lz4, and zstd.

          ### ðŸ§  Neuromorphic Indexes
          - **Hebbian Index**: Synaptic network-based adaptive indexing
          - **Comparison**: Hebbian vs B+ Tree performance
          - **Learning**: Hebbian and Anti-Hebbian weight updates

          ### ðŸ’³ Transactions
          - **Concurrent Transactions**: Throughput under concurrent load
          - **Savepoints**: Overhead for savepoint creation and rollback
          - **WAL Operations**: Write-Ahead Log performance
          - **Lock Manager**: Lock acquisition and deadlock detection

          ### âš›ï¸ Quantum Algorithms
          - **Grover's Search**: Quantum amplitude amplification vs classical search
          - **Quantum Annealing**: QUBO solver and optimization benchmarks

          ### ðŸ’¾ Storage
          - **B+ Tree**: Index operations (insert, search, range queries)
          - **Page Storage**: Buffer pool and page management performance

          ### ðŸš€ SIMD Optimizations
          NEON (ARM64) and AVX2 (x86-64) vectorized operations benchmarks.

          ### ðŸ“Š QSQL Functions
          - **NEUROMATCH**: Neuromorphic pattern matching vs SQL LIKE
          - **QUANTUM_SEARCH**: Quantum-inspired parallel search
          - **HEBBIAN_LEARNING**: Query optimization through learning
          - **SQL Parsing**: Query parsing performance

          ---
          EOF

          # Parse Criterion output for key metrics
          echo "## Performance Metrics" >> benchmark-results/summary.md
          echo "" >> benchmark-results/summary.md
          echo "| Benchmark | Mean Time | Std Dev | Throughput |" >> benchmark-results/summary.md
          echo "|-----------|-----------|---------|------------|" >> benchmark-results/summary.md

          # Extract metrics from criterion output (if available)
          if [ -d "target/criterion" ]; then
            for bench_dir in target/criterion/*/; do
              bench_name=$(basename "$bench_dir")
              if [ -f "$bench_dir/new/estimates.json" ]; then
                mean=$(cat "$bench_dir/new/estimates.json" 2>/dev/null | jq -r '.mean.point_estimate // "N/A"' | awk '{printf "%.2f Âµs", $1/1000}')
                std=$(cat "$bench_dir/new/estimates.json" 2>/dev/null | jq -r '.std_dev.point_estimate // "N/A"' | awk '{printf "%.2f Âµs", $1/1000}')
                echo "| $bench_name | $mean | Â±$std | - |" >> benchmark-results/summary.md
              fi
            done
          fi

          echo "" >> benchmark-results/summary.md
          echo "*Full reports available in artifacts*" >> benchmark-results/summary.md

      # =========================================
      # Upload Artifacts
      # =========================================
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: |
            target/criterion/
            benchmark-results/
          retention-days: 90

      # =========================================
      # Store Benchmark History (main branch only)
      # =========================================
      - name: Store benchmark data for GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: NeuroQuantumDB Benchmarks
          tool: 'cargo'
          output-file-path: target/criterion/**/new/estimates.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Comment on PRs with performance changes
          comment-on-alert: true
          # Alert if performance degrades by more than 10%
          alert-threshold: '110%'
          # Fail workflow if performance degrades by more than 30%
          fail-on-alert: true
          fail-threshold: '130%'
          # Store benchmark data
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      # =========================================
      # Post Performance Summary to PR
      # =========================================
      - name: Comment on PR with benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let summary = '';
            try {
              summary = fs.readFileSync('benchmark-results/summary.md', 'utf8');
            } catch (e) {
              summary = '## Benchmark Results\n\nBenchmark summary not available.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  benchmark-regression:
    name: Benchmark Regression Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Create data directory
        run: mkdir -p neuroquantum_data/{tables,indexes,logs,quantum}

      - name: Run benchmarks on PR branch
        run: |
          cargo bench --package neuroquantum-core --features benchmarks -- --noplot --save-baseline pr
          cargo bench --package neuroquantum-qsql --features benchmarks -- --noplot --save-baseline pr

      - name: Run benchmarks on base branch
        run: |
          cd base
          mkdir -p neuroquantum_data/{tables,indexes,logs,quantum}
          cargo bench --package neuroquantum-core --features benchmarks -- --noplot --save-baseline base
          cargo bench --package neuroquantum-qsql --features benchmarks -- --noplot --save-baseline base

      - name: Compare benchmarks
        run: |
          # Install critcmp for comparison
          cargo install critcmp --locked || true
          
          # Compare results
          echo "## Benchmark Comparison: PR vs Base" > comparison.md
          echo "" >> comparison.md
          critcmp base pr >> comparison.md 2>&1 || echo "No comparison data available" >> comparison.md
          
          cat comparison.md

      - name: Post comparison to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let comparison = '';
            try {
              comparison = fs.readFileSync('comparison.md', 'utf8');
            } catch (e) {
              comparison = '## Benchmark Comparison\n\nComparison data not available.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comparison
            });
