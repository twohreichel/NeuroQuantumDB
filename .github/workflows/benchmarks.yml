name: Benchmarks

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_comparison:
        description: 'Force benchmark comparison even on non-PR events'
        required: false
        type: boolean
        default: false

# Cancel in-progress workflows for the same branch
concurrency:
  group: benchmarks-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for baseline comparison

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.91.1"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          prefix-key: "benchmarks"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install cargo-criterion
        run: |
          cargo install cargo-criterion --locked || true

      - name: Create data directory
        run: mkdir -p neuroquantum_data/{tables,indexes,logs,quantum}

      # =========================================
      # Run DNA Compression Benchmarks
      # =========================================
      - name: Run DNA Compression Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench dna_compression \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Neuromorphic Index Benchmarks
      # =========================================
      - name: Run Neuromorphic Index Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench neuromorphic_index \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Transaction Benchmarks
      # =========================================
      - name: Run Transaction Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench transactions \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Quantum Algorithm Benchmarks
      # =========================================
      - name: Run Grover Search Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench grover_search \
            --features benchmarks \
            -- --noplot

      - name: Run Quantum Annealing Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench quantum_annealing \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run Storage Benchmarks
      # =========================================
      - name: Run B+ Tree Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench btree_benchmark \
            --features benchmarks \
            -- --noplot

      - name: Run Page Storage Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench page_storage_benchmark \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run SIMD Optimization Benchmarks
      # =========================================
      - name: Run NEON/SIMD Optimization Benchmarks
        run: |
          cargo bench --package neuroquantum-core \
            --bench neon_optimization \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Run QSQL Function Benchmarks
      # =========================================
      - name: Run QSQL Function Benchmarks
        run: |
          cargo bench --package neuroquantum-qsql \
            --bench qsql_functions \
            --features benchmarks \
            -- --noplot

      # =========================================
      # Collect and Process Results
      # =========================================
      - name: Collect benchmark results
        id: collect-results
        run: |
          # Create summary directory
          mkdir -p benchmark-results

          # Generate benchmark summary
          cat << 'EOF' > benchmark-results/summary.md
          # NeuroQuantumDB Benchmark Results

          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Benchmark Categories

          ### ðŸ§¬ DNA Compression
          Performance of DNA-based compression with quaternary encoding and Reed-Solomon error correction.
          Includes comparison with gzip, lz4, and zstd.

          ### ðŸ§  Neuromorphic Indexes
          - **Hebbian Index**: Synaptic network-based adaptive indexing
          - **Comparison**: Hebbian vs B+ Tree performance
          - **Learning**: Hebbian and Anti-Hebbian weight updates

          ### ðŸ’³ Transactions
          - **Concurrent Transactions**: Throughput under concurrent load
          - **Savepoints**: Overhead for savepoint creation and rollback
          - **WAL Operations**: Write-Ahead Log performance
          - **Lock Manager**: Lock acquisition and deadlock detection

          ### âš›ï¸ Quantum Algorithms
          - **Grover's Search**: Quantum amplitude amplification vs classical search
          - **Quantum Annealing**: QUBO solver and optimization benchmarks

          ### ðŸ’¾ Storage
          - **B+ Tree**: Index operations (insert, search, range queries)
          - **Page Storage**: Buffer pool and page management performance

          ### ðŸš€ SIMD Optimizations
          NEON (ARM64) and AVX2 (x86-64) vectorized operations benchmarks.

          ### ðŸ“Š QSQL Functions
          - **NEUROMATCH**: Neuromorphic pattern matching vs SQL LIKE
          - **QUANTUM_SEARCH**: Quantum-inspired parallel search
          - **HEBBIAN_LEARNING**: Query optimization through learning
          - **SQL Parsing**: Query parsing performance

          ---
          EOF

          # Parse Criterion output for key metrics
          echo "## Performance Metrics" >> benchmark-results/summary.md
          echo "" >> benchmark-results/summary.md
          echo "| Benchmark | Mean Time | Std Dev | Throughput |" >> benchmark-results/summary.md
          echo "|-----------|-----------|---------|------------|" >> benchmark-results/summary.md

          # Extract metrics from criterion output (if available)
          if [ -d "target/criterion" ]; then
            for bench_dir in target/criterion/*/; do
              bench_name=$(basename "$bench_dir")
              if [ -f "$bench_dir/new/estimates.json" ]; then
                mean=$(cat "$bench_dir/new/estimates.json" 2>/dev/null | jq -r '.mean.point_estimate // "N/A"' | awk '{printf "%.2f Âµs", $1/1000}')
                std=$(cat "$bench_dir/new/estimates.json" 2>/dev/null | jq -r '.std_dev.point_estimate // "N/A"' | awk '{printf "%.2f Âµs", $1/1000}')
                echo "| $bench_name | $mean | Â±$std | - |" >> benchmark-results/summary.md
              fi
            done
          fi

          echo "" >> benchmark-results/summary.md
          echo "*Full reports available in artifacts*" >> benchmark-results/summary.md

      # =========================================
      # Upload Artifacts
      # =========================================
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: |
            target/criterion/
            benchmark-results/
          retention-days: 90

      # =========================================
      # Store Benchmark History
      # =========================================
      - name: Generate consolidated benchmark JSON
        run: |
          # Create a consolidated benchmark output for github-action-benchmark
          # The tool expects a single file, not glob patterns
          echo '[]' > benchmark-results/consolidated.json
          
          # Find and merge all Criterion estimates
          for estimates in target/criterion/*/new/estimates.json; do
            if [ -f "$estimates" ]; then
              bench_name=$(basename $(dirname $(dirname "$estimates")))
              echo "Processing: $bench_name"
            fi
          done
          
          # Create benchmark summary JSON in cargo format
          cat << 'JSONEOF' > benchmark-results/benchmark-output.json
          {
            "reason": "benchmark-complete",
            "id": "NeuroQuantumDB Benchmarks",
            "mean": { "estimate": 0, "unit": "ns" },
            "commit": "${{ github.sha }}",
            "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          JSONEOF

      - name: Store benchmark data for GitHub Pages
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: NeuroQuantumDB Benchmarks
          tool: 'customSmallerIsBetter'
          output-file-path: benchmark-results/summary.md
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: false
          # Comment on PRs with performance changes
          comment-on-alert: true
          # Alert if performance degrades by more than 10%
          alert-threshold: '110%'
          # Store benchmark data
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench
        continue-on-error: true  # Don't fail the workflow if benchmark tracking fails
