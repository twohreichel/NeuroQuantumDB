# cargo-deny configuration for NeuroQuantumDB
# This file configures dependency auditing and security checks
#
# Security-First Configuration:
# - Strict advisory handling with documented exceptions
# - License compliance enforcement (confidence threshold 0.93)
# - Dependency version tracking for transitive dependencies
#
# Dependency Upgrade Plan (Issue #321):
# | Advisory           | Crate   | Status                                              | Priority |
# |--------------------|---------|-----------------------------------------------------|----------|
# | RUSTSEC-2025-0141  | bincode | Direct dependency - migration to v2.x planned      | Medium   |
# | RUSTSEC-2026-0002  | lru     | Transitive via aws-sdk-s3 - awaiting upstream fix  | Low      |

[graph]
# Target platforms for dependency resolution
targets = [
    { triple = "x86_64-unknown-linux-gnu" },
    { triple = "aarch64-unknown-linux-gnu" },
    { triple = "x86_64-apple-darwin" },
    { triple = "aarch64-apple-darwin" },
]

[output]
# Format for the output
feature-depth = 1

[advisories]
# The path where the advisory database is stored
db-path = "~/.cargo/advisory-db"
# The url(s) of the advisory databases to use
db-urls = ["https://github.com/rustsec/advisory-db"]
# Strict handling of unmaintained crates - check all dependencies
unmaintained = "workspace"
# Strict handling of yanked crates - deny by default
yanked = "deny"

# Documented exceptions only - each must have justification and planned resolution
ignore = [
    # RUSTSEC-2025-0141: bincode v1.x (unmaintained)
    # Justification: Direct dependency used extensively for binary serialization.
    #                v1.3.3 is considered feature-complete by maintainers.
    # Resolution: Migration to bincode v2.x/v3.x planned (breaking API change).
    #             See: https://github.com/bincode-org/bincode/blob/trunk/docs/migration_guide.md
    # Last reviewed: 2026-01-15
    { id = "RUSTSEC-2025-0141", reason = "Direct dep - v1.3.3 feature-complete, v2.x migration planned" },

    # RUSTSEC-2026-0002: lru v0.12.5 (security/unmaintained)
    # Justification: Transitive dependency locked by aws-sdk-s3 v1.119.0.
    #                Cannot update independently.
    # Resolution: Awaiting aws-sdk-s3 upstream update to newer lru version.
    # Last reviewed: 2026-01-15
    { id = "RUSTSEC-2026-0002", reason = "Transitive dep via aws-sdk-s3 - awaiting upstream fix" },
]

[licenses]
# Increased confidence threshold for license detection accuracy
confidence-threshold = 0.93
# List of explicitly allowed licenses (permissive only)
allow = [
    "MIT",
    "MIT-0",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "Unicode-3.0",
    "Zlib",
    "CC0-1.0",
    "Unlicense",
    "CDLA-Permissive-2.0", # Community Data License Agreement - used by webpki-roots
]
# Exceptions for crates with non-standard license files
exceptions = []

[bans]
# Warn about multiple versions of the same crate (common in large dependency trees)
multiple-versions = "warn"
# Warn about wildcard version requirements (path dependencies use implicit wildcards)
wildcards = "warn"
# Highlight all duplicate dependencies in graphs
highlight = "all"

# Skip known duplicate versions caused by transitive dependencies
# These are outside our control and will be resolved as upstream crates update
skip = [
    # AWS SDK and related ecosystem
    { crate = "indexmap@1", reason = "tower v0.4.x requires indexmap 1.x" },
    { crate = "hashlink@0.9", reason = "rusqlite requires hashlink 0.9.x" },
    { crate = "rustix@0.38", reason = "procfs requires rustix 0.38.x" },
    { crate = "linux-raw-sys@0.4", reason = "Paired with rustix 0.38.x" },
    { crate = "thiserror@1", reason = "opentelemetry/openraft use thiserror 1.x" },
    # Tonic/Prost ecosystem version splits
    { crate = "tonic@0.12", reason = "etcd-client/opentelemetry-otlp use tonic 0.12" },
    { crate = "prost@0.13", reason = "Paired with tonic 0.12" },
    { crate = "prost-build@0.13", reason = "Paired with tonic-build 0.12" },
    { crate = "prost-derive@0.13", reason = "Paired with prost 0.13" },
    { crate = "prost-types@0.13", reason = "Paired with prost 0.13" },
    { crate = "tonic-build@0.12", reason = "etcd-client uses tonic-build 0.12" },
    # Axum version splits
    { crate = "matchit@0.7", reason = "axum 0.7 requires matchit 0.7" },
    { crate = "axum@0.7", reason = "tonic 0.12 requires axum 0.7" },
]

# Skip entire dependency trees for transitive dependencies we can't control
skip-tree = [
    # AWS SDK has its own dependency management
    { crate = "aws-sdk-s3", depth = 5 },
]

# Banned crates for security or quality reasons
deny = []

[sources]
# Deny dependencies from unknown registries
unknown-registry = "deny"
# Deny dependencies from unknown git sources
unknown-git = "deny"
# Only allow crates from the official crates.io registry
allow-registry = ["https://github.com/rust-lang/crates.io-index"]
